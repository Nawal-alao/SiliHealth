<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic HealID</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-secondary { background: #6c757d; color: white; border: none; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .form-test { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic HealID</h1>

    <div class="section info">
        <h3>Instructions</h3>
        <p>Cette page diagnostique tous les composants du syst√®me HealID.</p>
        <p>Ouvrez la console (F12) pour voir les logs d√©taill√©s.</p>
    </div>

    <div class="section">
        <h3>1. √âtat des Services</h3>
        <button class="btn-primary" onclick="checkServices()">V√©rifier Services</button>
        <div id="services-result" class="result"></div>
    </div>

    <div class="section">
        <h3>2. JavaScript & Formulaires</h3>
        <button class="btn-primary" onclick="checkJavaScript()">V√©rifier JavaScript</button>
        <div id="js-result" class="result"></div>
    </div>

    <div class="section">
        <h3>3. Test Formulaire Connexion</h3>
        <div class="form-test">
            <form id="test-login-form" data-validate data-api="/api/login" method="post">
                <input type="email" name="email" value="alice.test.final@example.com" placeholder="Email" required>
                <input type="password" name="password" value="SecurePass123" placeholder="Mot de passe" required>
                <button type="submit">Tester Connexion</button>
            </form>
        </div>
        <div id="form-result" class="result"></div>
    </div>

    <div class="section">
        <h3>4. √âtat LocalStorage</h3>
        <button class="btn-secondary" onclick="checkLocalStorage()">V√©rifier LocalStorage</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="section">
        <h3>5. Actions de Debug</h3>
        <button class="btn-secondary" onclick="clearStorage()">Vider LocalStorage</button>
        <button class="btn-secondary" onclick="openConsole()">Ouvrir Console</button>
        <div id="debug-result" class="result"></div>
    </div>

    <script>
        // Simuler les fonctions du main.js pour le diagnostic
        const API_BASE = 'http://localhost:4000';
        const TOKEN_KEY = 'healid_token';
        const USER_KEY = 'healid_user';

        async function checkServices() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.innerHTML = 'V√©rification en cours...';

            const checks = [
                { name: 'Frontend (Port 3000)', url: 'http://localhost:3000/', method: 'HEAD' },
                { name: 'Backend API (Port 4000)', url: 'http://localhost:4000/api/health', method: 'GET' },
                { name: 'Page Login', url: 'http://localhost:3000/login', method: 'HEAD' },
                { name: 'Page Signup', url: 'http://localhost:3000/signup', method: 'HEAD' }
            ];

            let results = '';

            for (const check of checks) {
                try {
                    const response = await fetch(check.url, { method: check.method });
                    if (response.ok) {
                        results += `‚úÖ ${check.name}: OK (${response.status})<br>`;
                    } else {
                        results += `‚ö†Ô∏è ${check.name}: ${response.status}<br>`;
                    }
                } catch (error) {
                    results += `‚ùå ${check.name}: ERREUR - ${error.message}<br>`;
                }
            }

            resultDiv.innerHTML = results;
        }

        function checkJavaScript() {
            const resultDiv = document.getElementById('js-result');
            resultDiv.innerHTML = 'V√©rification JavaScript...<br>';

            // V√©rifier si les fonctions existent
            const functions = [
                'checkRoleBasedAccess',
                'submitFormToApi',
                'showToast',
                'renderAuthUI'
            ];

            functions.forEach(func => {
                if (typeof window[func] === 'function') {
                    resultDiv.innerHTML += `‚úÖ Fonction ${func}: OK<br>`;
                } else {
                    resultDiv.innerHTML += `‚ùå Fonction ${func}: MANQUANTE<br>`;
                }
            });

            // V√©rifier les formulaires
            const forms = document.querySelectorAll('form[data-validate]');
            resultDiv.innerHTML += `<br>üìù ${forms.length} formulaire(s) avec data-validate trouv√©(s)<br>`;

            forms.forEach((form, index) => {
                const api = form.getAttribute('data-api');
                const action = form.getAttribute('action');
                resultDiv.innerHTML += `Formulaire ${index + 1}: API=${api}, Action=${action || 'none'}<br>`;
            });
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('storage-result');

            const token = localStorage.getItem(TOKEN_KEY);
            const userData = localStorage.getItem(USER_KEY);

            let html = '<strong>LocalStorage:</strong><br>';

            if (token) {
                html += `‚úÖ Token: ${token.substring(0, 20)}...<br>`;
            } else {
                html += '‚ùå Pas de token<br>';
            }

            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    html += `‚úÖ Utilisateur: ${user.email} (${user.role})<br>`;
                } catch (e) {
                    html += '‚ùå Donn√©es utilisateur corrompues<br>';
                }
            } else {
                html += '‚ùå Pas de donn√©es utilisateur<br>';
            }

            resultDiv.innerHTML = html;
        }

        function clearStorage() {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem(USER_KEY);
            document.getElementById('debug-result').innerHTML = '‚úÖ LocalStorage vid√©';
            checkLocalStorage();
        }

        function openConsole() {
            document.getElementById('debug-result').innerHTML =
                'üîç Ouvrez la console (F12) pour voir les logs d√©taill√©s.<br>' +
                'Recherchez les messages avec üöÄ, üì°, üíæ, üîÑ';
        }

        // Diagnostic automatique au chargement
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Page de diagnostic charg√©e');
            setTimeout(() => {
                checkJavaScript();
                checkLocalStorage();
            }, 1000);
        });

        // Intercepter les soumissions de formulaire pour le diagnostic
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form.id === 'test-login-form') {
                console.log('üöÄ Formulaire de test soumis');
                document.getElementById('form-result').innerHTML = '‚úÖ Formulaire intercept√© par JavaScript';
                e.preventDefault(); // Emp√™cher la soumission r√©elle
            }
        });
    </script>
</body>
</html>
