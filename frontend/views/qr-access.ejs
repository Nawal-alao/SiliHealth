<!doctype html>
<html lang="fr">
  <%-  include('./partials/header.ejs') %>
  <main id="content" class="site">
    <div class="card" style="max-width:800px;margin:0 auto">
      <div id="qr-access-container">
        <!-- Loading state -->
        <div id="loading-state" class="loading-state">
          <div class="spinner"></div>
          <p class="muted">Chargement des informations du patient...</p>
        </div>

        <!-- Error state -->
        <div id="error-state" class="error-state" style="display:none">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2>Patient non trouv√©</h2>
          <p class="muted">Le QR code scann√© ne correspond √† aucun patient dans notre syst√®me.</p>
          <a href="/" class="btn btn--primary">Retour √† l'accueil</a>
        </div>

        <!-- Patient info (minimal) -->
        <div id="patient-info-minimal" class="patient-info-section" style="display:none">
          <div class="patient-header">
            <h2>üì± Acc√®s QR Code Patient</h2>
            <div class="patient-basic-info">
              <div class="info-item">
                <strong>Nom complet:</strong>
                <span id="patient-fullname">-</span>
              </div>
              <div class="info-item">
                <strong>ID Patient:</strong>
                <span id="patient-id-display" class="patient-id-badge">-</span>
              </div>
            </div>
          </div>

          <div class="access-actions">
            <button id="request-full-access" class="btn btn--primary">
              üîì Demander acc√®s au dossier complet
            </button>
            <p class="muted" style="margin-top:12px;font-size:13px">
              L'acc√®s complet n√©cessite une authentification et sera journalis√©.
            </p>
          </div>
        </div>

        <!-- Emergency mode -->
        <div id="emergency-mode" class="emergency-mode-section" style="display:none">
          <div class="emergency-banner">
            <h2>üö® MODE URGENCE ACTIV√â</h2>
            <p class="emergency-warning-text">
              Acc√®s d'urgence aux informations vitales uniquement. Toutes les actions sont journalis√©es.
            </p>
          </div>

          <div class="vital-info-grid">
            <div class="vital-card">
              <div class="vital-label">Groupe sanguin</div>
              <div class="vital-value" id="emergency-blood-type">Non sp√©cifi√©</div>
            </div>
            <div class="vital-card">
              <div class="vital-label">Allergies</div>
              <div class="vital-value" id="emergency-allergies">Aucune connue</div>
            </div>
            <div class="vital-card">
              <div class="vital-label">Maladies chroniques</div>
              <div class="vital-value" id="emergency-chronic">Aucune</div>
            </div>
            <div class="vital-card">
              <div class="vital-label">M√©dicaments actuels</div>
              <div class="vital-value" id="emergency-medications">Aucun</div>
            </div>
            <div class="vital-card">
              <div class="vital-label">Contact d'urgence</div>
              <div class="vital-value" id="emergency-contact">Non sp√©cifi√©</div>
            </div>
          </div>

          <div class="emergency-log-info">
            <p class="muted">
              <strong>Acc√®s enregistr√©:</strong> <span id="emergency-access-time"></span>
            </p>
          </div>
        </div>

        <!-- Full access granted -->
        <div id="full-access-granted" class="full-access-section" style="display:none">
          <div class="success-banner">
            <h2>‚úÖ Acc√®s autoris√©</h2>
            <p>Redirection vers le dossier patient...</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  <%-  include('./partials/footer.ejs') %>

  <script>
    const API_BASE = 'http://localhost:4000';
    const TOKEN_KEY = 'healid_token';
    const USER_KEY = 'healid_user';

    // Get patient ID from URL
    function getPatientIdFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/qr-access\/([a-f0-9-]+)/i);
      return match ? match[1] : null;
    }

    // Check if emergency mode
    function isEmergencyMode() {
      const params = new URLSearchParams(window.location.search);
      return params.get('emergency') === 'true';
    }

    // Get device fingerprint
    function getDeviceFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Device fingerprint', 2, 2);
      
      const fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        canvas: canvas.toDataURL().substring(0, 50)
      };
      
      return btoa(JSON.stringify(fingerprint)).substring(0, 32);
    }

    // Load patient info
    async function loadPatientInfo(patientId, emergency = false) {
      const loadingEl = document.getElementById('loading-state');
      const errorEl = document.getElementById('error-state');
      const minimalEl = document.getElementById('patient-info-minimal');
      const emergencyEl = document.getElementById('emergency-mode');
      const fullAccessEl = document.getElementById('full-access-granted');

      try {
        if (emergency) {
          // Emergency mode - get vital info directly via patientId
          const response = await fetch(`${API_BASE}/api/qr/access/${patientId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.ok && result.patient) {
            // Log emergency access
            await logQRAccess(patientId, true, getDeviceFingerprint());

            // Show emergency info
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            emergencyEl.style.display = 'block';

            // Populate emergency data
            const patient = result.patient;
            document.getElementById('emergency-blood-type').textContent = patient.bloodType || 'Non sp√©cifi√©';
            document.getElementById('emergency-allergies').textContent = formatArray(patient.allergies) || 'Aucune connue';
            document.getElementById('emergency-chronic').textContent = formatArray(patient.chronicConditions) || 'Aucune';
            document.getElementById('emergency-medications').textContent = formatArray(patient.currentMedications) || 'Aucun';
            document.getElementById('emergency-contact').textContent = 
              patient.emergencyContactName ? 
                `${patient.emergencyContactName}${patient.emergencyContactPhone ? ' - ' + patient.emergencyContactPhone : ''}` :
                'Non sp√©cifi√©';
            
            document.getElementById('emergency-access-time').textContent = new Date().toLocaleString('fr-FR');
          } else {
            throw new Error('Patient non trouv√©');
          }
        } else {
          // Normal mode - minimal info only via patientId
          const response = await fetch(`${API_BASE}/api/qr/access/${patientId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.ok && result.patient) {
            // Log QR scan
            await logQRAccess(patientId, false, getDeviceFingerprint());

            // Show minimal info
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            minimalEl.style.display = 'block';

            const patient = result.patient;
            document.getElementById('patient-fullname').textContent = patient.fullname || 'Non sp√©cifi√©';
            document.getElementById('patient-id-display').textContent = patient.patientId || patientId;
          } else {
            throw new Error('Patient non trouv√©');
          }
        }
      } catch (error) {
        console.error('Erreur chargement patient:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
      }
    }

    // Log QR access
    async function logQRAccess(patientId, emergency, deviceFingerprint) {
      try {
        await fetch(`${API_BASE}/api/qr/log-access`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            patientId,
            emergency,
            deviceFingerprint,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
          })
        });
      } catch (error) {
        console.error('Erreur journalisation QR:', error);
      }
    }

    // Request full access
    async function requestFullAccess(patientId) {
      const token = localStorage.getItem(TOKEN_KEY);
      const user = localStorage.getItem(USER_KEY);

      if (!token || !user) {
        // Redirect to login with return URL
        const returnUrl = encodeURIComponent(window.location.pathname);
        window.location.href = `/login?returnUrl=${returnUrl}`;
        return;
      }

      try {
        // Check if user has permission
        const userData = JSON.parse(user);
        
        // If agent, grant access immediately
        if (userData.role === 'agent_de_sante') {
          window.location.href = `/patient-record?patientId=${patientId}`;
          return;
        }

        // If patient, check if it's their own record
        if (userData.role === 'patient') {
          // Get patient profile to check ownership
          const response = await fetch(`${API_BASE}/api/patients/profile`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          const result = await response.json();
          if (result.ok && result.patient && result.patient.patientId === patientId) {
            window.location.href = `/dashboard-patient`;
            return;
          }
        }

        // Access denied
        alert('Vous n\'avez pas l\'autorisation d\'acc√©der √† ce dossier.');
      } catch (error) {
        console.error('Erreur demande acc√®s:', error);
        alert('Erreur lors de la demande d\'acc√®s.');
      }
    }

    // Format array data
    function formatArray(data) {
      if (!data) return null;
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch (e) {
          return data;
        }
      }
      if (Array.isArray(data)) {
        return data.map(item => {
          if (typeof item === 'object') {
            return item.name || item.medication || item.condition || JSON.stringify(item);
          }
          return item;
        }).join(', ');
      }
      return data;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      const patientId = getPatientIdFromUrl();
      const emergency = isEmergencyMode();

      if (!patientId) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        return;
      }

      // Load patient info
      loadPatientInfo(patientId, emergency);

      // Request full access button
      const requestBtn = document.getElementById('request-full-access');
      if (requestBtn) {
        requestBtn.addEventListener('click', () => {
          requestFullAccess(patientId);
        });
      }
    });
  </script>

  <style>
    .loading-state {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 4px solid var(--soft);
      border-top: 4px solid var(--brand-500);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .patient-info-section {
      padding: 24px;
    }

    .patient-header {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(14,23,34,0.08);
    }

    .patient-header h2 {
      margin: 0 0 16px 0;
      color: var(--text);
    }

    .patient-basic-info {
      display: grid;
      gap: 12px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item strong {
      color: var(--muted);
      font-weight: 600;
      min-width: 120px;
    }

    .patient-id-badge {
      background: var(--brand-500);
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      font-family: monospace;
    }

    .access-actions {
      text-align: center;
      padding: 24px 0;
    }

    .emergency-mode-section {
      padding: 24px;
    }

    .emergency-banner {
      background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1));
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .emergency-banner h2 {
      margin: 0 0 8px 0;
      color: #dc2626;
    }

    .emergency-warning-text {
      margin: 0;
      color: #dc2626;
      font-weight: 600;
    }

    .vital-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .vital-card {
      background: var(--surface);
      border: 1px solid rgba(14,23,34,0.08);
      border-radius: 10px;
      padding: 16px;
    }

    .vital-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .vital-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .emergency-log-info {
      text-align: center;
      padding: 16px;
      background: var(--soft);
      border-radius: 8px;
    }

    .full-access-section {
      text-align: center;
      padding: 40px 20px;
    }

    .success-banner {
      background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 24px;
    }

    .success-banner h2 {
      margin: 0 0 8px 0;
      color: #059669;
    }
  </style>
</html>
