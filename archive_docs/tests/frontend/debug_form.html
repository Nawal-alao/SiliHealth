<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Formulaire Inscription</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 300px; padding: 8px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #result { margin-top: 20px; padding: 10px; background: #f5f5f5; }
        pre { background: white; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Formulaire d'Inscription HealID</h1>
    <p>Cette page teste exactement le m√™me comportement que le formulaire r√©el du site.</p>

    <form id="signup-form" data-validate data-api="/api/signup" method="post" action="http://localhost:4000/api/signup">
        <div class="form-group">
            <label>Pr√©nom</label>
            <input class="input" name="firstName" value="Marie" required>
        </div>

        <div class="form-group">
            <label>Nom</label>
            <input class="input" name="lastName" value="Dupont" required>
        </div>

        <div class="form-group">
            <label>Email</label>
            <input class="input" type="email" name="email" value="marie.debug@example.com" required>
        </div>

        <div class="form-group">
            <label>Mot de passe</label>
            <input class="input" type="password" name="password" value="SecurePass123" required>
        </div>

        <div class="form-group">
            <label>Confirmer mot de passe</label>
            <input class="input" type="password" name="confirm_password" value="SecurePass123" required>
        </div>

        <div class="form-group">
            <label>Vous √™tes</label>
            <select class="input" name="role" id="role-select" required>
                <option value="">S√©lectionnez votre r√¥le</option>
                <option value="patient">Patient</option>
                <option value="agent_de_sante">Agent de sant√©</option>
            </select>
        </div>

        <!-- Champs sp√©cifiques aux patients -->
        <div id="patient-fields" style="display: none; border: 1px solid #ccc; padding: 15px; margin: 10px 0;">
            <h3>Informations patient</h3>

            <div class="form-group">
                <label>Sexe de naissance</label>
                <select class="input" name="sexAtBirth">
                    <option value="">S√©lectionnez</option>
                    <option value="F">Femme</option>
                    <option value="M">Homme</option>
                    <option value="Other">Autre</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date de naissance</label>
                <input class="input" type="date" name="birthDate" required>
            </div>

            <div class="form-group">
                <label>T√©l√©phone</label>
                <input class="input" type="tel" name="phone" placeholder="+33123456789">
            </div>

            <div class="form-group">
                <label>Adresse</label>
                <input class="input" name="addressLine1" placeholder="Num√©ro et rue">
            </div>

            <div class="form-group">
                <label>Ville</label>
                <input class="input" name="city">
            </div>

            <div class="form-group">
                <label>Code postal</label>
                <input class="input" name="postalCode" pattern="[0-9]{5}" placeholder="75001">
            </div>

            <div class="form-group">
                <label>Nom du contact d'urgence</label>
                <input class="input" name="emergencyContactName">
            </div>

            <div class="form-group">
                <label>T√©l√©phone du contact d'urgence</label>
                <input class="input" type="tel" name="emergencyContactPhone" placeholder="+33123456789">
            </div>
        </div>

        <!-- Champs sp√©cifiques aux agents de sant√© -->
        <div id="agent-fields" style="display: none; border: 1px solid #ccc; padding: 15px; margin: 10px 0;">
            <h3>Informations professionnelles</h3>

            <div class="form-group">
                <label>Num√©ro de licence</label>
                <input class="input" name="licenseNumber" placeholder="Ex: MED123456">
            </div>

            <div class="form-group">
                <label>Sp√©cialit√©</label>
                <input class="input" name="specialty" placeholder="Ex: M√©decine g√©n√©rale">
            </div>

            <div class="form-group">
                <label>Service/D√©partement</label>
                <input class="input" name="department" placeholder="Ex: M√©decine interne">
            </div>
        </div>

        <!-- Consentement obligatoire -->
        <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px;">
            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="consentForDataProcessing" value="true" required style="margin-top: 2px;">
                <span style="font-size: 14px; line-height: 1.4;">
                    J'accepte que mes donn√©es soient collect√©es et trait√©es conform√©ment √† la politique de confidentialit√© de HealID.
                    <strong>Cette autorisation est obligatoire pour cr√©er un compte.</strong>
                </span>
            </label>
            <br><br>
            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="shareWithResearch" value="true" style="margin-top: 2px;">
                <span style="font-size: 14px; line-height: 1.4;">
                    J'accepte que mes donn√©es anonymis√©es soient utilis√©es √† des fins de recherche m√©dicale (optionnel).
                </span>
            </label>
        </div>

        <button class="btn" type="submit">S'inscrire</button>
    </form>

    <div id="result"></div>

    <script>
        // Gestion des champs conditionnels selon le r√¥le (copi√© du site principal)
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('role-select');
            const patientFields = document.getElementById('patient-fields');
            const agentFields = document.getElementById('agent-fields');

            function toggleFields() {
                const selectedRole = roleSelect.value;

                if (selectedRole === 'patient') {
                    patientFields.style.display = 'block';
                    agentFields.style.display = 'none';
                    // Rendre les champs patient requis
                    document.querySelector('[name="sexAtBirth"]').setAttribute('required', 'true');
                    document.querySelector('[name="birthDate"]').setAttribute('required', 'true');
                } else if (selectedRole === 'agent_de_sante') {
                    patientFields.style.display = 'none';
                    agentFields.style.display = 'block';
                    // Retirer les required des champs patient
                    document.querySelector('[name="sexAtBirth"]').removeAttribute('required');
                    document.querySelector('[name="birthDate"]').removeAttribute('required');
                } else {
                    patientFields.style.display = 'none';
                    agentFields.style.display = 'none';
                    // Retirer les required des champs patient
                    document.querySelector('[name="sexAtBirth"]').removeAttribute('required');
                    document.querySelector('[name="birthDate"]').removeAttribute('required');
                }
            }

            roleSelect.addEventListener('change', toggleFields);
            toggleFields(); // Appel initial
        });

        // Validation JavaScript (simplifi√©e)
        function clearFieldErrors(form) {
            form.querySelectorAll('.field-error').forEach(el => el.remove());
            form.querySelectorAll('[aria-invalid]').forEach(i => {
                i.removeAttribute('aria-invalid');
                i.removeAttribute('aria-describedby');
            });
        }

        function showFieldError(fieldEl, message) {
            if (!fieldEl) return;
            fieldEl.setAttribute('aria-invalid', 'true');
            const id = fieldEl.id || (fieldEl.name ? 'err-' + fieldEl.name : 'err-' + Math.random().toString(36).slice(2, 8));
            const msgId = id + '-error';
            fieldEl.id = fieldEl.id || id;
            fieldEl.setAttribute('aria-describedby', msgId);
            const span = document.createElement('div');
            span.className = 'field-error';
            span.id = msgId;
            span.role = 'alert';
            span.textContent = message;
            span.style.color = 'red';
            span.style.marginTop = '5px';
            span.style.fontSize = '12px';
            if (fieldEl.nextSibling) fieldEl.parentNode.insertBefore(span, fieldEl.nextSibling);
            else fieldEl.parentNode.appendChild(span);
        }

        // Gestion du formulaire (simplifi√©e)
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = this;
            clearFieldErrors(form);

            // Validation simple des champs requis
            let hasErrors = false;
            form.querySelectorAll('[required]').forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    showFieldError(input, 'Ce champ est requis');
                    hasErrors = true;
                }
            });

            // Validation des mots de passe
            const password = form.querySelector('[name="password"]').value;
            const confirmPassword = form.querySelector('[name="confirm_password"]').value;
            if (password !== confirmPassword) {
                showFieldError(form.querySelector('[name="confirm_password"]'), 'Les mots de passe ne correspondent pas');
                hasErrors = true;
            }

            if (hasErrors) {
                document.getElementById('result').innerHTML = '<p style="color: red;">‚ùå Erreurs de validation d√©tect√©es. Corrigez-les avant de soumettre.</p>';
                return;
            }

            // Collecte des donn√©es
            const data = {};
            new FormData(form).forEach((v, k) => {
                // Convertir les checkboxes
                if (k === 'consentForDataProcessing' || k === 'shareWithResearch') {
                    data[k] = v === 'true';
                } else {
                    data[k] = v;
                }
            });

            console.log('Donn√©es envoy√©es:', data);

            document.getElementById('result').innerHTML = `
                <h2>üîç Donn√©es envoy√©es au backend:</h2>
                <pre>${JSON.stringify(data, null, 2)}</pre>
                <p>üì° Envoi en cours...</p>
            `;

            // Test avec l'API r√©elle
            try {
                const response = await fetch('http://localhost:4000/api/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                let resultHtml = `
                    <h2>üìã R√©ponse du backend:</h2>
                    <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;

                if (response.ok) {
                    resultHtml += '<p style="color: green;">‚úÖ Inscription r√©ussie !</p>';

                    // Tester la connexion automatiquement
                    setTimeout(async () => {
                        try {
                            const loginResponse = await fetch('http://localhost:4000/api/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    email: data.email,
                                    password: data.password
                                })
                            });

                            const loginResult = await loginResponse.json();
                            resultHtml += `
                                <h3>üîë Test de connexion automatique:</h3>
                                <p><strong>Status:</strong> ${loginResponse.status}</p>
                                <pre>${JSON.stringify(loginResult, null, 2)}</pre>
                            `;

                            if (loginResponse.ok) {
                                resultHtml += '<p style="color: green;">‚úÖ Connexion r√©ussie !</p>';
                            } else {
                                resultHtml += '<p style="color: red;">‚ùå √âchec de connexion</p>';
                            }

                            document.getElementById('result').innerHTML += resultHtml;
                        } catch (loginError) {
                            resultHtml += `<p style="color: red;">‚ùå Erreur de connexion: ${loginError.message}</p>`;
                            document.getElementById('result').innerHTML += resultHtml;
                        }
                    }, 500);
                } else {
                    resultHtml += '<p style="color: red;">‚ùå Erreur d\'inscription</p>';
                }

                document.getElementById('result').innerHTML = resultHtml;

            } catch (error) {
                document.getElementById('result').innerHTML += `
                    <h2>üö® Erreur r√©seau:</h2>
                    <p style="color: red;">${error.message}</p>
                    <p>V√©rifiez que le backend fonctionne sur http://localhost:4000</p>
                `;
            }
        });
    </script>
</body>
</html>
