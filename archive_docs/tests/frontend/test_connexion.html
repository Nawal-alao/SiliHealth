<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connexion Direct</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .result { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Connexion Direct</h1>

    <form id="login-form" data-validate data-api="/api/login" method="post">
        <div class="form-group">
            <label>Email:</label>
            <input type="email" name="email" value="alice.test.final@example.com" required>
        </div>

        <div class="form-group">
            <label>Mot de passe:</label>
            <input type="password" name="password" value="SecurePass123" required>
        </div>

        <button type="submit">Se Connecter</button>
    </form>

    <div id="result" class="result"></div>

    <script>
        // Simuler les fonctions nÃ©cessaires du main.js
        const API_BASE = 'http://localhost:4000';
        const TOKEN_KEY = 'healid_token';
        const USER_KEY = 'healid_user';

        function showToast(message, type = 'info') {
            console.log(`ğŸ Toast: ${message} (${type})`);
        }

        function renderAuthUI() {
            console.log('ğŸ¨ UI mise Ã  jour');
        }

        // Fonction principale de soumission
        async function submitFormToApi(form, api) {
            console.log('ğŸ“¡ Envoi vers API:', api);

            const method = 'POST';
            let body;
            let headers = {};

            const token = localStorage.getItem(TOKEN_KEY);
            if (token) headers['Authorization'] = `Bearer ${token}`;

            // CrÃ©er les donnÃ©es
            const data = {};
            new FormData(form).forEach((v, k) => {
                if (k === 'consentForDataProcessing' || k === 'shareWithResearch') {
                    data[k] = v === 'true';
                } else {
                    data[k] = v;
                }
            });
            body = JSON.stringify(data);
            headers['Content-Type'] = 'application/json';

            const url = api.startsWith('http') ? api : `${API_BASE}${api}`;
            console.log('ğŸ”— URL complÃ¨te:', url);
            console.log('ğŸ“¦ DonnÃ©es envoyÃ©es:', data);

            try {
                const res = await fetch(url, { method, body, headers });
                console.log('ğŸ“¡ RÃ©ponse HTTP:', res.status);

                const json = await res.json();
                console.log('ğŸ“¡ RÃ©ponse JSON:', json);

                if (!json || !json.ok) {
                    throw new Error(json && json.error ? json.error : 'API error');
                }

                // Traitement spÃ©cifique pour la connexion
                if (api.includes('login')) {
                    console.log('ğŸ” Traitement connexion');

                    if (json.token) {
                        localStorage.setItem(TOKEN_KEY, json.token);
                        console.log('ğŸ’¾ Token stockÃ©');
                    }
                    if (json.user) {
                        localStorage.setItem(USER_KEY, JSON.stringify(json.user));
                        console.log('ğŸ‘¤ Utilisateur stockÃ©:', json.user.role);
                    }

                    renderAuthUI();
                    showToast('Connexion rÃ©ussie !', 'success');

                    const userRole = json.user.role;
                    const redirectUrl = userRole === 'patient' ? '/dashboard-patient' : '/dashboard-agent';
                    console.log('ğŸ”„ Redirection vers:', redirectUrl);

                    setTimeout(() => {
                        console.log('âš¡ Redirection exÃ©cutÃ©e');
                        window.location.href = redirectUrl;
                    }, 1000);
                }

                return json;

            } catch (error) {
                console.error('âŒ Erreur:', error);
                showToast('Erreur: ' + error.message, 'error');
                return { ok: false, error: error.message };
            }
        }

        // Attacher les event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ DOM chargÃ©');

            const forms = document.querySelectorAll('form[data-validate]');
            console.log(`ğŸ“Š ${forms.length} formulaire(s) trouvÃ©(s)`);

            forms.forEach((form, index) => {
                const api = form.getAttribute('data-api');
                console.log(`ğŸ“ Formulaire ${index + 1}: API=${api}`);

                form.addEventListener('submit', function(e) {
                    console.log('ğŸš€ Soumission interceptÃ©e');
                    e.preventDefault();
                    submitFormToApi(form, api);
                });
            });
        });
    </script>
</body>
</html>
